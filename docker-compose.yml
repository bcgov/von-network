version: '3'
services:
  #
  # Client
  #
  client:
    image: von-network-base
    command: ./scripts/start_client.sh
    environment:
      - IP=${IP}
      - IPS=${IPS}
      - DOCKERHOST=${DOCKERHOST}
      - RUST_LOG=${RUST_LOG}
    networks:
      - von
    volumes:
      - client-data:/home/indy/.indy_client
      - ./tmp:/tmp

  #
  # Webserver
  #
  webserver:
    image: von-network-base
    command: bash -c 'sleep 10 && ./scripts/start_webserver.sh'
    environment:
      - IP=${IP}
      - IPS=${IPS}
      - NODE_PORTS=${NODE1_PORT1:-9701},${NODE1_PORT2:-9702},${NODE2_PORT1:-9703},${NODE2_PORT2:-9704},${NODE3_PORT1:-9705},${NODE3_PORT2:-9706},${NODE4_PORT1:-9707},${NODE4_PORT2:-9708}
      - DOCKERHOST=${DOCKERHOST}
      - LOG_LEVEL=${LOG_LEVEL}
      - RUST_LOG=${RUST_LOG}
      - GENESIS_URL=${GENESIS_URL}
      - LEDGER_SEED=${LEDGER_SEED}
      - LEDGER_CACHE_PATH=${LEDGER_CACHE_PATH}
      - MAX_FETCH=${MAX_FETCH:-50000}
      - RESYNC_TIME=${RESYNC_TIME:-120}
      - POOL_CONNECTION_ATTEMPTS=${POOL_CONNECTION_ATTEMPTS:-5}
      - POOL_CONNECTION_DELAY=${POOL_CONNECTION_DELAY:-10}
      - REGISTER_NEW_DIDS=${REGISTER_NEW_DIDS:-True}
      - LEDGER_INSTANCE_NAME=${LEDGER_INSTANCE_NAME:-localhost}
      - WEB_ANALYTICS_SCRIPT=${WEB_ANALYTICS_SCRIPT}
      - INFO_SITE_TEXT=${INFO_SITE_TEXT}
      - INFO_SITE_URL=${INFO_SITE_URL}
      - INDY_SCAN_URL=${INDY_SCAN_URL}
      - INDY_SCAN_TEXT=${INDY_SCAN_TEXT}
    networks:
      - von
    ports:
      - ${WEB_SERVER_HOST_PORT:-9000}:8000
    volumes:
      - ./config:/home/indy/config
      - ./server:/home/indy/server
      - webserver-cli:/home/indy/.indy-cli
      - webserver-ledger:/home/indy/ledger

  #
  # Synchronization test
  #
  synctest:
    image: von-network-base
    command: ./scripts/start_synctest.sh
    environment:
      - IP=${IP}
      - IPS=${IPS}
      - DOCKERHOST=${DOCKERHOST}
      - LOG_LEVEL=${LOG_LEVEL}
      - RUST_LOG=${RUST_LOG}
    networks:
      - von
    ports:
      - ${WEB_SERVER_HOST_PORT:-9000}:8000
    volumes:
      - ./config:/home/indy/config
      - ./server:/home/indy/server
      - webserver-cli:/home/indy/.indy-cli
      - webserver-ledger:/home/indy/ledger

  #
  # Nodes
  #
  nodes:
    image: von-network-base
    command: ./scripts/start_nodes.sh ${NODE1_PORT1:-9701} ${NODE1_PORT2:-9702} ${NODE2_PORT1:-9703} ${NODE2_PORT2:-9704} ${NODE3_PORT1:-9705} ${NODE3_PORT2:-9706} ${NODE4_PORT1:-9707} ${NODE4_PORT2:-9708}
    networks:
      - von
    ports:
      - ${NODE1_EXPOSED_PORT1:-${NODE1_PORT1:-9701}}:${NODE1_PORT1:-9701}
      - ${NODE1_EXPOSED_PORT2:-${NODE1_PORT2:-9702}}:${NODE1_PORT2:-9702}
      - ${NODE2_EXPOSED_PORT1:-${NODE2_PORT1:-9703}}:${NODE2_PORT1:-9703}
      - ${NODE2_EXPOSED_PORT2:-${NODE2_PORT2:-9704}}:${NODE2_PORT2:-9704}
      - ${NODE3_EXPOSED_PORT1:-${NODE3_PORT1:-9705}}:${NODE3_PORT1:-9705}
      - ${NODE3_EXPOSED_PORT2:-${NODE3_PORT2:-9706}}:${NODE3_PORT2:-9706}
      - ${NODE4_EXPOSED_PORT1:-${NODE4_PORT1:-9707}}:${NODE4_PORT1:-9707}
      - ${NODE4_EXPOSED_PORT2:-${NODE4_PORT2:-9708}}:${NODE4_PORT2:-9708}
    environment:
      - IP=${IP}
      - IPS=${IPS}
      - NODE_PORTS=${NODE1_PORT1:-9701},${NODE1_PORT2:-9702},${NODE2_PORT1:-9703},${NODE2_PORT2:-9704},${NODE3_PORT1:-9705},${NODE3_PORT2:-9706},${NODE4_PORT1:-9707},${NODE4_PORT2:-9708}
      - DOCKERHOST=${DOCKERHOST}
      - LOG_LEVEL=${LOG_LEVEL}
      - RUST_LOG=${RUST_LOG}
    volumes:
      - nodes-data:/home/indy/ledger

  node1:
    image: von-network-base
    command: ./scripts/start_node.sh 1 ${NODE1_PORT1:-9701} ${NODE1_PORT2:-9702}
    networks:
      - von
    ports:
      - ${NODE1_EXPOSED_PORT1:-${NODE1_PORT1:-9701}}:${NODE1_PORT1:-9701}
      - ${NODE1_EXPOSED_PORT2:-${NODE1_PORT2:-9702}}:${NODE1_PORT2:-9702}
    environment:
      - IP=${IP}
      - IPS=${IPS}
      - NODE_PORTS=${NODE1_PORT1:-9701},${NODE1_PORT2:-9702},${NODE2_PORT1:-9703},${NODE2_PORT2:-9704},${NODE3_PORT1:-9705},${NODE3_PORT2:-9706},${NODE4_PORT1:-9707},${NODE4_PORT2:-9708}
      - DOCKERHOST=${DOCKERHOST}
      - LOG_LEVEL=${LOG_LEVEL}
      - RUST_LOG=${RUST_LOG}
    volumes:
      - node1-data:/home/indy/ledger

  node2:
    image: von-network-base
    command: ./scripts/start_node.sh 2 ${NODE2_PORT1:-9703} ${NODE2_PORT2:-9704}
    networks:
      - von
    ports:
      - ${NODE2_EXPOSED_PORT1:-${NODE2_PORT1:-9703}}:${NODE2_PORT1:-9703}
      - ${NODE2_EXPOSED_PORT2:-${NODE2_PORT2:-9704}}:${NODE2_PORT2:-9704}
    environment:
      - IP=${IP}
      - IPS=${IPS}
      - NODE_PORTS=${NODE1_PORT1:-9701},${NODE1_PORT2:-9702},${NODE2_PORT1:-9703},${NODE2_PORT2:-9704},${NODE3_PORT1:-9705},${NODE3_PORT2:-9706},${NODE4_PORT1:-9707},${NODE4_PORT2:-9708}
      - DOCKERHOST=${DOCKERHOST}
      - LOG_LEVEL=${LOG_LEVEL}
      - RUST_LOG=${RUST_LOG}
    volumes:
      - node2-data:/home/indy/ledger

  node3:
    image: von-network-base
    command: ./scripts/start_node.sh 3 ${NODE3_PORT1:-9705} ${NODE3_PORT2:-9706}
    networks:
      - von
    ports:
      - ${NODE3_EXPOSED_PORT1:-${NODE3_PORT1:-9705}}:${NODE3_PORT1:-9705}
      - ${NODE3_EXPOSED_PORT2:-${NODE3_PORT2:-9706}}:${NODE3_PORT2:-9706}
    environment:
      - IP=${IP}
      - IPS=${IPS}
      - NODE_PORTS=${NODE1_PORT1:-9701},${NODE1_PORT2:-9702},${NODE2_PORT1:-9703},${NODE2_PORT2:-9704},${NODE3_PORT1:-9705},${NODE3_PORT2:-9706},${NODE4_PORT1:-9707},${NODE4_PORT2:-9708}
      - DOCKERHOST=${DOCKERHOST}
      - LOG_LEVEL=${LOG_LEVEL}
      - RUST_LOG=${RUST_LOG}
    volumes:
      - node3-data:/home/indy/ledger

  node4:
    image: von-network-base
    command: ./scripts/start_node.sh 4 ${NODE4_PORT1:-9707} ${NODE4_PORT2:-9708}
    networks:
      - von
    ports:
      - ${NODE4_EXPOSED_PORT1:-${NODE4_PORT1:-9707}}:${NODE4_PORT1:-9707}
      - ${NODE4_EXPOSED_PORT2:-${NODE4_PORT2:-9708}}:${NODE4_PORT2:-9708}
    environment:
      - IP=${IP}
      - IPS=${IPS}
      - NODE_PORTS=${NODE1_PORT1:-9701},${NODE1_PORT2:-9702},${NODE2_PORT1:-9703},${NODE2_PORT2:-9704},${NODE3_PORT1:-9705},${NODE3_PORT2:-9706},${NODE4_PORT1:-9707},${NODE4_PORT2:-9708}
      - DOCKERHOST=${DOCKERHOST}
      - LOG_LEVEL=${LOG_LEVEL}
      - RUST_LOG=${RUST_LOG}
    volumes:
      - node4-data:/home/indy/ledger

networks:
  von:

volumes:
  client-data:
  webserver-cli:
  webserver-ledger:
  node1-data:
  node2-data:
  node3-data:
  node4-data:
  nodes-data:
